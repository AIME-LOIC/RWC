<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RwandaChat Dashboard</title>
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <link rel="icon" href="/static/image/logo.png" type="image/png"/>
  <style>
    /* ==== GLOBAL THEME TOKENS ==== */
    :root {
      --primary-color: #1a7e3c;   /* Rwanda Green */
      --secondary-color: #00a1de; /* Rwanda Yellow */
      --accent-color: #00a1de;    /* Rwanda Blue */
      --bg-color: #f0f2f5;        /* RwandaChat Light BG */
      --card-bg-color: #fff;      /* RwandaChat Card Light */
      --text-color: #222;         /* RwandaChat Text */
      --text-secondary-color: #3b5e2b; /* Muted green */
      --light-gray: #e0e0e0;
      --success-color: #1a7e3c;
      --error-color: #e74c3c;
      --sidebar-width: 250px;
      --mobile-nav-height: 60px;
      --notif-bg: #e0f7fa;
      --notif-unread-bg: #fffde7;
      --notif-text: #1a7e3c;
      --story-modal-bg: #1a7e3c;
      --story-modal-text: #fff;

      --font-size-base: 16px;
      --font-family-base: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { font-size: var(--font-size-base); }
    body {
      font-family: var(--font-family-base);
      background: var(--bg-color);
      color: var(--text-color);
      overflow-x: hidden;
    }

    /* ==== UTILS ==== */
    .hidden { display: none !important; }

    /* ==== LOADER ==== */
    .loader-container { display:flex; justify-content:center; align-items:center; padding:40px; }
    .loader {
      border: 4px solid var(--light-gray);
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      width: 40px; height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ==== LAYOUT ==== */
    .dashboard-container { display:flex; }
    .sidebar {
      width: var(--sidebar-width);
      height: 100vh;
      background: black;
      border-right: 1px solid var(--light-gray);
      display:flex; flex-direction:column;
      position: fixed; top:0; left:0; padding:20px 0;
      transition: transform .3s ease;
    }
    .logo { font-size: 1.8rem; font-weight: 800; color: var(--primary-color); padding: 0 20px; margin-bottom: 30px; }
    .nav-links { list-style:none; flex-grow:1; }
    .nav-link {
      display:flex; align-items:center; gap:15px;
      padding: 12px 20px; color: var(--text-secondary-color);
      text-decoration: none; font-weight: 500;
      transition: background .2s, color .2s;
    }
    .nav-link i { width: 30px; font-size: 1.2rem; }
    .nav-link:hover { background: var(--bg-color); }
    .nav-link.active {
      color: #fff; font-weight: 700;
      background: #00a1de; border-right: 3px solid #1a7e3c;
    }
    #logout-btn {
      background:none; border:none; cursor:pointer; font-size:1rem;
      font-weight: 600; text-align:left; width:100%;
      padding: 15px 20px; color: var(--error-color);
      display:flex; align-items:center; gap:15px;
    }

    .main-content {
      margin-left: var(--sidebar-width);
      width: calc(100% - var(--sidebar-width));
      padding: 20px; overflow-y: auto;
    }

    .content-section { display:none; animation: fadeIn .4s; }
    .content-section.active { display:block; }
    @keyframes fadeIn { from {opacity:0} to {opacity:1} }

    h2 { margin-bottom: 16px; }

    .section-header { display:flex; justify-content:space-between; align-items:center; margin-bottom: 18px; }

    .btn-primary, .btn-secondary {
      background: #004a99 !important;
      color: #fff !important;
      border: none;
      border-radius: 8px;
      box-shadow: none;
      padding: 10px 18px;
      font-weight: 700;
      transition: background .2s;
    }
    .btn-primary:hover, .btn-secondary:hover {
      background: #003366 !important;
    }
    .btn-secondary {
      background: #00a1de;
      color: #1a7e3c;
      border: none;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
    }

    /* ==== CARDS & POSTS ==== */
    .card {
      background: var(--card-bg-color);
      border: 1px solid #00a1de;
      border-radius: 10px; margin-bottom: 16px; padding: 14px;
      box-shadow: 0 1px 2px rgba(0,0,0,.06);
    }
    .post-header { display:flex; align-items:center; gap:10px; margin-bottom: 10px; }
    .avatar { width:40px; height:40px; border-radius:50%; object-fit:cover; }
    .post-header .username { font-weight: 800; }
    .timestamp { color: var(--text-secondary-color); font-size: .85rem; margin-left:auto; }
    .post-content p { white-space: pre-wrap; margin-bottom: 8px; }
    .post-media-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(120px,1fr)); gap:6px; margin-top: 8px; }
    .post-media { width:100%; height:auto; object-fit:cover; border-radius:8px; cursor:pointer; }
    .post-actions { display:flex; align-items:center; gap:20px; margin-top: 8px; border-top: 1px solid var(--bg-color); padding-top: 8px; }
    .action-btn{ background:none; border:none; cursor:pointer; font-size:1.15rem; color: var(--text-secondary-color); display:flex; align-items:center; gap:6px; }
    .like-btn.liked { color: var(--error-color); }

    /* ==== CHAT ==== */
    .chat-layout { display:flex; height: calc(100vh - 120px); background: var(--card-bg-color); border:1px solid var(--light-gray); border-radius: 10px; }
    .chat-partners { width:35%; border-right:1px solid var(--light-gray); overflow-y:auto; }
    .chat-partner-item { display:flex; align-items:center; gap:10px; padding:14px; cursor:pointer; border-bottom:1px solid var(--bg-color); }
    .chat-partner-item:hover, .chat-partner-item.active { background: var(--bg-color); }
    .chat-partner-item .avatar { width:45px; height:45px; }
    .chat-partner-item .name { font-weight: 800; }
    .chat-window { width:65%; display:flex; flex-direction:column; }
    .chat-header { padding:10px 14px; border-bottom:1px solid var(--light-gray); font-weight:800; display:flex; align-items:center; justify-content:space-between; }
    .chat-window-placeholder { margin:auto; text-align:center; color: var(--text-secondary-color); }
    #chat-messages-area { flex-grow:1; padding: 16px; overflow-y:auto; display:flex; flex-direction:column; gap:12px; }
    .message-bubble { padding:10px 14px; border-radius: 18px; max-width: 70%; line-height:1.4; }
    .message-bubble.sent { background: var(--primary-color); color:#fff; align-self:flex-end; border-bottom-right-radius:6px; }
    .message-bubble.received { background: var(--bg-color); color: var(--text-color); align-self:flex-start; border-bottom-left-radius:6px; }
    #message-form { display:flex; gap:8px; padding: 10px; border-top:1px solid var(--light-gray); }
    #message-input { flex-grow:1; border:1px solid var(--light-gray); border-radius: 999px; padding:10px 14px; font-size:1rem; }
    #message-form button { background:none; border:none; font-size:1.5rem; color: var(--primary-color); cursor:pointer; }

    /* ==== ADS ==== */
    .ads-container { display:grid; grid-template-columns: repeat(auto-fill, minmax(250px,1fr)); gap:16px; }
    .ad-card .post-media { width:100%; height:150px; }

    /* ==== STORIES ==== */
    .stories-list { display:flex; gap:14px; padding-bottom:14px; border-bottom:1px solid var(--light-gray); margin-bottom: 16px; overflow-x:auto; }
    .story-item { text-align:center; cursor:pointer; flex-shrink:0; }
    .story-item .avatar { width:60px; height:60px; border:3px solid var(--primary-color); padding:2px; background:#fff; }

    /* ==== NOTIFICATIONS ==== */
    .notification-list { list-style:none; }
.notification-item {
  display:flex; align-items:center; gap:12px; padding:14px; border-bottom:1px solid var(--bg-color); cursor:pointer; transition: background .2s;
  background: var(--notif-bg);
  color: var(--notif-text);
}
.notification-item.unread {
  background: var(--notif-unread-bg);
  font-weight:700;
  color: var(--primary-color);
}
.notification-item:hover {
  background: var(--accent-color);
  color: #fff;
}
.notification-item i {
  font-size:1.4rem; color: var(--primary-color);
}

    /* ==== PROFILE ==== */
    .profile-details-card { display:flex; flex-direction:column; align-items:center; text-align:center; gap:6px; }
    #profile-pic-large { width:120px; height:120px; border-radius:50%; object-fit:cover; border:4px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,.2); }

    /* ==== SETTINGS ==== */
    .settings-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); gap:16px; }
    .settings-group h3 { margin-bottom:8px; }
    .settings-row { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 0; border-bottom:1px dashed var(--bg-color); }
    .settings-row:last-child { border-bottom: none; }
    .settings-row .control { display:flex; align-items:center; gap:8px; }
    .radio-row { display:flex; gap:8px; flex-wrap:wrap; }
    .support-form { display:flex; flex-direction:column; gap:10px; }
    .support-form input, .support-form textarea, .support-form select {
      width:100%; padding:10px; border:1px solid var(--light-gray); border-radius:8px;
    }

    /* ==== MODALS ==== */
    .modal-overlay{
      position: fixed; inset:0; background: rgba(0,0,0,.6); display:none;
      justify-content:center; align-items:center; z-index:1000;
    }
    .modal-content{
      background: #fff; width: min(92%, 520px); padding: 24px;
      border-radius: 12px; position:relative;
}

#story-viewer-modal .modal-content {
  background: var(--story-modal-bg) !important;
  color: var(--story-modal-text) !important;
}
#story-viewer-modal .modal-content * {
  color: var(--story-modal-text) !important;
}
#story-viewer-modal .modal-content input,
#story-viewer-modal .modal-content textarea,
#story-viewer-modal .modal-content select {
  background: #fff;
  color: #1a7e3c;
}
    
    .modal-close-btn{
      position:absolute; top:10px; right:12px; background:none; border:none;
      font-size:1.6rem; cursor:pointer; color: var(--text-secondary-color);
    }
    .modal-content form{ display:flex; flex-direction:column; gap:12px; }
    .modal-content input, .modal-content textarea, .modal-content select{
      width:100%; padding:10px; border:1px solid var(--light-gray); border-radius:8px;
    }

    /* ==== TOAST ==== */
    .toast{
      position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
      padding: 12px 20px; border-radius: 10px; color:#fff; font-weight: 800;
      z-index: 2000; opacity:0; transition: opacity .25s, bottom .25s;
    }
    .toast.show{ opacity:1; bottom: 100px; }
    .toast.success{ background: var(--success-color); }
    .toast.error{ background: var(--error-color); }

    /* ==== MOBILE ==== */
    .mobile-nav, .mobile-header { display:none; }
    @media (max-width: 768px){
      .sidebar { transform: translateX(-100%); }
      .main-content { margin-left:0; width:100%; padding:15px; padding-bottom: calc(var(--mobile-nav-height) + 18px); }
      .mobile-nav{
        display:flex; position:fixed; bottom:0; left:0; width:100%; height:var(--mobile-nav-height);
        background: #004a99; border-top:1px solid var(--light-gray);
        justify-content:space-around; align-items:center; z-index:500;
      }
      .mobile-nav-link{ color: #fff; font-size:1.5rem; flex-grow:1; text-align:center; padding:10px 0; }
      .mobile-nav-link.active{ color: #00a1de; }
      /* Make updates and notifications more visible */
      .nav-link-mobile-header[data-section="updates"],
      .nav-link-mobile-header[data-section="notifications"] {
        background: #f7b731;
        color: #004a99;
        border-radius: 50%;
        padding: 8px;
        margin: 0 4px;
      }
    }

    /* ==== DARK MODE BASE ==== */
    .theme-dark {
      --bg-color: #0f1115;
      --card-bg-color: #151821;
      --text-color: white;
      --text-secondary-color: #00a1de;
      --primary-color: white;
      --secondary-color: #00a1de;
      --accent-color: #00a1de;
      --light-gray: #222;
    }
    #logo img{
      width: 100px;
    }

    /* ==== MOOD PRESETS (adjust primary + secondary) ==== */
    .mood-blue   { --primary-color:#004a99; --secondary-color:#f7b731; }
    .mood-green  { --primary-color:#00a1de; --secondary-color:#00a1de; }
  </style>
</head>
<body>

  <div class="dashboard-container">
    <nav class="sidebar">
      <ul class="nav-links">
        <li><a href="#" class="nav-link active" data-section="home"><i class="fas fa-home"></i><span>Home</span></a></li>
        <li><a href="#" class="nav-link" data-section="chat"><i class="fas fa-comments"></i><span>Chat</span></a></li>
        <li><a href="#" class="nav-link" data-section="search"><i class="fas fa-search"></i><span>Search</span></a></li>
        <li><a href="#" class="nav-link" data-section="explore"><i class="fas fa-compass"></i><span>Explore</span></a></li>
        <li><a href="#" class="nav-link" data-section="updates"><i class="fas fa-history"></i><span>Updates</span></a></li>
        <li><a href="#" class="nav-link" data-section="notifications"><i class="fas fa-bell"></i><span>Notifications</span></a></li>
        <li><a href="#" class="nav-link" data-section="profile"><i class="fas fa-user"></i><span>Profile</span></a></li>
        <li><a href="#" class="nav-link" data-section="settings"><i class="fas fa-gear"></i><span>Settings</span></a></li>
      </ul>
      <div style="padding: 0 20px 20px 20px;">
        <select id="lang-select-desktop" style="width:100%;padding:6px 10px; border-radius:8px;">
          <option value="en">English</option>
          <option value="ki">Kinyarwanda</option>
          <option value="sw">Swahili</option>
          <option value="fr">Français</option>
        </select>
      </div>
      <a href="/logout" id="logout-btn"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
    </nav>

    <main class="main-content">
      <!-- Mobile header -->
      <header class="mobile-header">
        <h1 class="logo">RwandaChat</h1>
        <div class="mobile-header-icons">
          <button class="nav-link-mobile-header" data-section="updates"><i class="fas fa-history"></i></button>
          <button class="nav-link-mobile-header" data-section="notifications"><i class="fas fa-bell"></i></button>
        </div>
        <div style="margin-left:auto;">
          <select id="lang-select" style="padding:6px 10px; border-radius:8px;">
            <option value="en">English</option>
            <option value="ki">Kinyarwanda</option>
            <option value="sw">Swahili</option>
            <option value="fr">Français</option>
          </select>
        </div>
      </header>

      
      <!-- HOME -->
      <section id="home" class="content-section active">
        <h2>Home Feed</h2>
        <div id="posts-feed" class="feed-container"><div class="loader-container"><div class="loader"></div></div></div>
      </section>

      <!-- CHAT -->
      <section id="chat" class="content-section">
        <div class="section-header">
          <h2>Chat</h2>
          <button id="new-chat-btn" class="btn-primary"><i class="fas fa-plus"></i> New Chat</button>
        </div>
        <div class="chat-layout">
          <div id="chat-partners-list" class="chat-partners"><div class="loader-container"><div class="loader"></div></div></div>
          <div id="chat-window" class="chat-window">
            <div id="chat-header" class="chat-header hidden"></div>
            <div class="chat-window-placeholder">Select a conversation to start chatting.</div>
            <div id="chat-messages-area"></div>
            <form id="message-form" class="hidden" enctype="multipart/form-data">
              <input type="text" id="message-input" name="text" placeholder="Type a message..." autocomplete="off"/>
              <input type="file" id="message-media-input" name="media" accept="image/*,video/*" style="display:none;"/>
              <input type="hidden" id="message-receiver-input" name="receiver"/>
              <button type="button" id="attach-media-btn" title="Attach media" style="font-size:1.5rem; color:var(--primary-color); background:none; border:none; cursor:pointer;">
                <i class="fas fa-paperclip"></i>
              </button>
              <button type="submit" title="Send"><i class="fas fa-paper-plane"></i></button>
            </form>
          </div>
        </div>
      </section>

      <!-- SEARCH -->
      <section id="search" class="content-section">
        <h2>Search</h2>
        <form id="search-form">
          <input type="search" id="search-input" placeholder="Search for posts, ads, or users..." required/>
          <button type="submit" class="btn-primary">Search</button>
        </form>
        <div id="search-results-container"></div>
      </section>

      <!-- EXPLORE -->
      <section id="explore" class="content-section">
        <div class="section-header">
          <h2>Explore Ads</h2>
          <button id="create-ad-btn" class="btn-primary"><i class="fas fa-plus-circle"></i> Create New Ad</button>
        </div>
        <div id="ads-grid" class="ads-container"><div class="loader-container"><div class="loader"></div></div></div>
      </section>

      <!-- UPDATES -->
      <section id="updates" class="content-section">
        <div class="section-header">
          <h2>Updates (Stories)</h2>
          <button id="create-story-btn" class="btn-primary"><i class="fas fa-plus-circle"></i> Add Story</button>
        </div>
        <div id="stories-container" class="stories-list"><div class="loader-container"><div class="loader"></div></div></div>
      </section>

      <!-- NOTIFICATIONS -->
      <section id="notifications" class="content-section">
        <h2>Notifications</h2>
        <ul id="notifications-list" class="notification-list"><div class="loader-container"><div class="loader"></div></div></ul>
      </section>

      <!-- PROFILE -->
      <section id="profile" class="content-section">
        <div class="section-header">
          <h2>Profile</h2>
          <button id="edit-profile-btn" class="btn-secondary"><i class="fas fa-edit"></i> Edit Profile</button>
        </div>
        <div class="card profile-details-card">
          <!-- Removed http placeholder; JS will set src to user's pic or generated avatar -->
          <img alt="Profile Picture" id="profile-pic-large"/>
          <h3 id="profile-name">{{ user.name }}</h3>
          <p id="profile-username">@{{ user.username }}</p>
          <p id="profile-bio">{{ user.bio or 'No bio yet.' }}</p>
          <p id="profile-phone"><strong>Phone:</strong> {{ user.phone }}</p>
        </div>
        <div class="card create-post-card" style="margin-top:24px;">
          <h3>Create Post</h3>
          <form id="create-post-form-main">
            <textarea name="content" placeholder="What's on your mind, {{ user.name }}?"></textarea>
            <div class="form-actions" style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
              <input type="file" name="media" multiple accept="image/*,video/*"/>
              <button type="submit" class="btn-primary">Post</button>
            </div>
          </form>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="settings" class="content-section">
        <h2>Settings</h2>
        <div class="settings-grid">
          <div class="card settings-group">
            <h3>Appearance</h3>
            <div class="settings-row">
              <span>Theme</span>
              <div class="control">
                <label><input type="checkbox" id="toggle-dark"/> Dark</label>
              </div>
            </div>
            <div class="settings-row">
              <span>Mood</span>
              <div class="radio-row">
                <label><input type="radio" name="mood" value="blue"   checked/> Deep Blue</label>
                <label><input type="radio" name="mood" value="green" /> Serene Green</label>
              </div>
            </div>
            <div class="settings-row">
              <span>Font Size</span>
              <div class="control">
                <input type="range" id="font-size-range" min="14" max="20" step="1"/>
                <span id="font-size-label"></span>
              </div>
            </div>
            <div class="settings-row">
              <span>Font Family</span>
              <select id="font-family-select">
                <option value='-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif'>System UI</option>
                <option value='Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif'>Inter</option>
                <option value='Roboto, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif'>Roboto</option>
                <option value='Georgia, "Times New Roman", serif'>Georgia</option>
              </select>
            </div>
          </div>

          <div class="card settings-group">
            <h3>Support — System</h3>
            <form id="system-support-form" class="support-form">
              <input type="text" name="subject" placeholder="Subject" required/>
              <textarea name="message" rows="5" placeholder="Describe your issue..." required></textarea>
              <button class="btn-primary" type="submit">Send to System Support</button>
            </form>
          </div>

          <div class="card settings-group">
            <h3>Support — Government</h3>
            <form id="gov-support-form" class="support-form">
              <select name="category" required>
                <option value="">Select category</option>
                <option value="harassment">Harassment / Threat</option>
                <option value="fraud">Fraud / Scam</option>
                <option value="illegal">Illegal Content</option>
                <option value="other">Other</option>
              </select>
              <textarea name="message" rows="5" placeholder="Provide details (include usernames, links, timestamps)..." required></textarea>
              <button class="btn-primary" type="submit">Send to Gov Support</button>
            </form>
          </div>
        </div>
      </section>
    </main>

    <!-- MOBILE NAV -->
    <nav class="mobile-nav">
      <a href="#" class="mobile-nav-link" data-section="home"><i class="fas fa-home"></i></a>
      <a href="#" class="mobile-nav-link" data-section="chat"><i class="fas fa-comments"></i></a>
      <a href="#" class="mobile-nav-link" data-section="search"><i class="fas fa-search"></i></a>
      <a href="#" class="mobile-nav-link" data-section="explore"><i class="fas fa-compass"></i></a>
      <a href="#" class="mobile-nav-link" data-section="updates"><i class="fas fa-history"></i></a>
      <a href="#" class="mobile-nav-link" data-section="notifications"><i class="fas fa-bell"></i></a>
      <a href="#" class="mobile-nav-link" data-section="profile"><i class="fas fa-user"></i></a>
      <a href="#" class="mobile-nav-link" data-section="settings"><i class="fas fa-gear"></i></a>
      <select id="lang-select-mobile" style="margin-left:8px;padding:6px 10px; border-radius:8px;">
        <option value="en">English</option>
        <option value="ki">Kinyarwanda</option>
        <option value="sw">Swahili</option>
        <option value="fr">Français</option>
      </select>
    </nav>
  </div>

  <!-- MODALS -->
  <div id="ad-modal" class="modal-overlay">
    <div class="modal-content" style="background-color: #1a7e3c;">
      <button class="modal-close-btn" aria-label="Close">&times;</button>
      <h3>Create a New Advertisement</h3>
      <form id="create-ad-form">
        <label>Ad Content:</label>
        <textarea name="content" required placeholder="Describe your product or service..."></textarea>
        <label>Payment Method:</label>
        <select name="payment" required>
          <option value="momo">Mobile Money</option>
          <option value="card">Credit Card</option>
          <option value="bank">Bank Transfer</option>
        </select>
        <label>Upload Media (Optional):</label>
        <input type="file" name="media" multiple accept="image/*"/>
        <button type="submit" class="btn-primary">Publish Ad</button>
      </form>
    </div>
  </div>

  <div id="story-modal" class="modal-overlay">
    <div class="modal-content" style="background-color: #1a7e3c;">
      <button class="modal-close-btn" aria-label="Close">&times;</button>
      <h3>Create a New Story</h3>
      <form id="create-story-form">
        <label>Content:</label>
        <textarea name="content" required placeholder="Add some text..."></textarea>
        <label>Upload Media:</label>
        <input type="file" name="media" multiple accept="image/*,video/*" required/>
        <button type="submit" class="btn-primary">Share Story</button>
      </form>
    </div>
  </div>

  <div id="edit-profile-modal" class="modal-overlay">
    <div class="modal-content" style="background-color: #1a7e3c;">
      <button class="modal-close-btn" aria-label="Close">&times;</button>
      <h3>Edit Your Profile</h3>
      <form id="edit-profile-form">
        <label>Name:</label>
        <input type="text" id="edit-name" name="name" value="{{ user.name }}"/>
        <label>Bio:</label>
        <textarea id="edit-bio" name="bio" placeholder="Tell us about yourself...">{{ user.bio }}</textarea>
        <label>Phone:</label>
        <input type="tel" id="edit-phone" name="phone" value="{{ user.phone }}"/>
        <label>Profile Picture:</label>
        <input type="file" id="edit-profile-pic" name="profile_pic" accept="image/*"/>
        <button type="submit" class="btn-primary">Save Changes</button>
      </form>
    </div>
  </div>

  <!-- New Chat Modal -->
  <div id="new-chat-modal" class="modal-overlay">
    <div class="modal-content">
      <button class="modal-close-btn" aria-label="Close">&times;</button>
      <h3>Start a New Chat</h3>
      <div id="new-chat-list" class="card" style="max-height: 360px; overflow:auto;"></div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Story Viewer Modal -->
  <div id="story-viewer-modal" class="modal-overlay" style="z-index:2001;">
    <div class="modal-content" style="max-width:420px;">
      <button class="modal-close-btn" aria-label="Close">&times;</button>
      <div class="story-viewer-content"></div>
      <div style="display:flex;justify-content:space-between;margin-top:16px;">
        <button class="btn-secondary story-prev-btn">&larr; Prev</button>
        <button class="btn-secondary story-next-btn">Next &rarr;</button>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // --- Fix: syncLangSelectors definition ---
    function syncLangSelectors(lang) {
      try {
        document.getElementById('lang-select').value = lang;
      } catch {}
      try {
        document.getElementById('lang-select-desktop').value = lang;
      } catch {}
      try {
        document.getElementById('lang-select-mobile').value = lang;
      } catch {}
    }
    // Multi-language support
    const langMap = {
      en: {
        home: "Home Feed",
        chat: "Chat",
        search: "Search",
        explore: "Explore Ads",
        updates: "Updates (Stories)",
        notifications: "Notifications",
        profile: "Profile",
        settings: "Settings",
        createPost: "Create Post",
        editProfile: "Edit Profile",
        appearance: "Appearance",
        supportSystem: "Support — System",
        supportGov: "Support — Government",
        logout: "Logout",
        newChat: "New Chat",
        addStory: "Add Story",
        createAd: "Create New Ad",
        publishAd: "Publish Ad",
        shareStory: "Share Story",
        saveChanges: "Save Changes",
        sendSystem: "Send to System Support",
        sendGov: "Send to Gov Support"
      },
      ki: {
        home: "Ahabanza",
        chat: "Ubutumwa",
        search: "Shakisha",
        explore: "Iyamamaza",
        updates: "Amakuru (Inkuru)",
        notifications: "Itangazo",
        profile: "Umwirondoro",
        settings: "Igenamiterere",
        createPost: "Andika Post",
        editProfile: "Hindura Umwirondoro",
        appearance: "Imyambarire",
        supportSystem: "Inkunga — Sisitemu",
        supportGov: "Inkunga — Leta",
        logout: "Sohoka",
        newChat: "Ubutumwa bushya",
        addStory: "Ongeraho Inkuru",
        createAd: "Iyamamaza rishya",
        publishAd: "Ohereza Iyamamaza",
        shareStory: "Sangira Inkuru",
        saveChanges: "Bika Impinduka",
        sendSystem: "Ohereza kuri Sisitemu",
        sendGov: "Ohereza kuri Leta"
      },
      sw: {
        home: "Nyumbani",
        chat: "Ujumbe",
        search: "Tafuta",
        explore: "Matangazo",
        updates: "Habari (Hadithi)",
        notifications: "Arifa",
        profile: "Wasifu",
        settings: "Mipangilio",
        createPost: "Unda Chapisho",
        editProfile: "Hariri Wasifu",
        appearance: "Mwonekano",
        supportSystem: "Msaada — Mfumo",
        supportGov: "Msaada — Serikali",
        logout: "Toka",
        newChat: "Ujumbe Mpya",
        addStory: "Ongeza Hadithi",
        createAd: "Tangazo Jipya",
        publishAd: "Chapisha Tangazo",
        shareStory: "Shiriki Hadithi",
        saveChanges: "Hifadhi Mabadiliko",
        sendSystem: "Tuma kwa Mfumo",
        sendGov: "Tuma kwa Serikali"
      },
      fr: {
        home: "Accueil",
        chat: "Discussion",
        search: "Recherche",
        explore: "Publicités",
        updates: "Mises à jour (Histoires)",
        notifications: "Notifications",
        profile: "Profil",
        settings: "Paramètres",
        createPost: "Créer une publication",
        editProfile: "Modifier le profil",
        appearance: "Apparence",
        supportSystem: "Support — Système",
        supportGov: "Support — Gouvernement",
        logout: "Déconnexion",
        newChat: "Nouveau Chat",
        addStory: "Ajouter une histoire",
        createAd: "Nouvelle publicité",
        publishAd: "Publier la publicité",
        shareStory: "Partager l'histoire",
        saveChanges: "Enregistrer les modifications",
        sendSystem: "Envoyer au système",
        sendGov: "Envoyer au gouvernement"
      }
    };
    function setLang(lang) {
      const t = langMap[lang] || langMap.ki;
      document.querySelector('#home h2').textContent = t.home;
      document.querySelector('#chat h2').textContent = t.chat;
      document.querySelector('#search h2').textContent = t.search;
      document.querySelector('#explore h2').textContent = t.explore;
      document.querySelector('#updates h2').textContent = t.updates;
      document.querySelector('#notifications h2').textContent = t.notifications;
      document.querySelector('#profile h2').textContent = t.profile;
      document.querySelector('#settings h2').textContent = t.settings;
      document.querySelector('#create-post-form-main').parentElement.querySelector('h3').textContent = t.createPost;
      document.getElementById('edit-profile-btn').innerHTML = `<i class="fas fa-edit"></i> ${t.editProfile}`;
      document.querySelector('.settings-group h3').textContent = t.appearance;
      document.querySelectorAll('.settings-group h3')[1].textContent = t.supportSystem;
      document.querySelectorAll('.settings-group h3')[2].textContent = t.supportGov;
      document.getElementById('logout-btn').innerHTML = `<i class="fas fa-sign-out-alt"></i><span>${t.logout}</span>`;
      document.getElementById('new-chat-btn').innerHTML = `<i class="fas fa-plus"></i> ${t.newChat}`;
      document.getElementById('create-story-btn').innerHTML = `<i class="fas fa-plus-circle"></i> ${t.addStory}`;
      document.getElementById('create-ad-btn').innerHTML = `<i class="fas fa-plus-circle"></i> ${t.createAd}`;
      document.querySelector('#create-ad-form button[type="submit"]').textContent = t.publishAd;
      document.querySelector('#create-story-form button[type="submit"]').textContent = t.shareStory;
      document.querySelector('#edit-profile-form button[type="submit"]').textContent = t.saveChanges;
      document.querySelector('#system-support-form button[type="submit"]').textContent = t.sendSystem;
      document.querySelector('#gov-support-form button[type="submit"]').textContent = t.sendGov;
    }
    document.getElementById('lang-select').addEventListener('change', function(){
      setLang(this.value);
      localStorage.setItem('rwchat.lang', this.value);
    });
    document.getElementById('lang-select-desktop').addEventListener('change', function(){
      setLang(this.value);
      localStorage.setItem('rwchat.lang', this.value);
    });
    document.getElementById('lang-select-mobile').addEventListener('change', function(){
      setLang(this.value);
      localStorage.setItem('rwchat.lang', this.value);
    });
    // Default to Kinyarwanda
    const savedLang = localStorage.getItem('rwchat.lang') || 'ki';
    syncLangSelectors(savedLang);
    setLang(savedLang);
    /* ================= GLOBAL STATE ================ */
    const currentUser = {
      username: "{{ user.username }}",
      name: "{{ user.name }}",
      profile_pic: "{{ user.profile_pic }}"
    };
    let allUsers;
    try {
      allUsers = JSON.parse('{{ users | tojson | safe }}');
      if (!Array.isArray(allUsers)) allUsers = [];
    } catch (e) {
      allUsers = [];
    }
    const loadedSections = new Set();

    /* ================= DOM ================= */
    const allNavLinks = document.querySelectorAll('.nav-link, .mobile-nav-link, .nav-link-mobile-header');
    const contentSections = document.querySelectorAll('.content-section');
    const mainContent = document.querySelector('.main-content');
    const toastElement = document.getElementById('toast');

    const modals = {
      ad: document.getElementById('ad-modal'),
      story: document.getElementById('story-modal'),
      editProfile: document.getElementById('edit-profile-modal'),
      newChat: document.getElementById('new-chat-modal')
    };

    /* ================= HELPERS ================= */
    function avatarDataURL(name = '') {
      const initials = (name || '?').trim().split(/\s+/).slice(0,2).map(s => s[0]?.toUpperCase() || '').join('');
      const bg = '#'+(Math.abs(hashCode(name)) % 0xffffff).toString(16).padStart(6,'0');
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="150" height="150">
          <rect width="100%" height="100%" rx="75" ry="75" fill="${bg}"/>
          <text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle"
                font-family="Arial, Helvetica, sans-serif" font-size="60" fill="#ffffff">${initials || '?'}</text>
        </svg>`;
      return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
    }
    function hashCode(str='') { let h=0; for (let i=0;i<str.length;i++) { h=((h<<5)-h)+str.charCodeAt(i); h|=0; } return h; }

    function showToast(message, type='success'){
      toastElement.textContent = message;
      toastElement.className = `toast show ${type}`;
      setTimeout(()=> toastElement.className = 'toast', 2800);
    }

    async function apiFetch(url, options = {}) {
      // Add cache-busting param to always get fresh data
      const bust = '_ts=' + Date.now() + Math.floor(Math.random()*10000);
      let fullUrl = url;
      if (url.indexOf('?') === -1) {
        fullUrl += '?' + bust;
      } else {
        fullUrl += '&' + bust;
      }
      try{
        const response = await fetch(fullUrl, options);
        if (response.status === 401) { window.location.href = '/login-page'; return null; }
        if (!response.ok) {
          let msg = `HTTP ${response.status}`;
          try { const err = await response.json(); msg = err.message || err.error || msg; } catch {}
          throw new Error(msg);
        }
        if (response.status === 204) return { success: true };
        const len = response.headers.get('content-length');
        if (len === '0' || len === null) {
          try { return await response.json(); } catch { return { success:true }; }
        }
        return await response.json();
      } catch (e) {
        console.error('API Fetch Error:', e);
        showToast(e.message, 'error');
        return null;
      }
    }

    const timeAgo = (dateString) => {
    // Always parse as UTC for correct time
    const date = typeof dateString === 'string' && dateString.endsWith('Z')
      ? new Date(dateString)
      : new Date(dateString + 'Z');
      const seconds = Math.floor((new Date() - date) / 1000);
      let interval = seconds / 31536000;
      if (interval > 1) return Math.floor(interval) + "y";
      interval = seconds / 2592000;
      if (interval > 1) return Math.floor(interval) + "m";
      interval = seconds / 86400;
      if (interval > 1) return Math.floor(interval) + "d";
      interval = seconds / 3600;
      if (interval > 1) return Math.floor(interval) + "h";
      interval = seconds / 60;
      if (interval > 1) return Math.floor(interval) + "m";
      return Math.floor(seconds) + "s";
    };

    function userDetails(username){
      return allUsers.find(u => u.username === username) || { name: username || 'Unknown', profile_pic: '' };
    }

    /* ================= RENDERERS ================= */
    function renderPosts(container, posts){
      container.innerHTML = '';
      if (!posts || posts.length === 0){
        container.innerHTML = '<p style="text-align:center; color: #65676b;">No posts to show.</p>';
        return;
      }
      // Pagination state
      let page = 1;
      const pageSize = 10;
      let allPosts = posts;
      function renderPage(){
        container.innerHTML = '';
        const start = 0;
        const end = page * pageSize;
        const pagePosts = allPosts.slice(start, end);
        pagePosts.forEach(post => {
          const author = userDetails(post.username);
          const el = document.createElement('div');
          el.className = 'card';
          const authorPic = author.profile_pic ? author.profile_pic : avatarDataURL(author.name);
          el.innerHTML = `
            <div class="post-header">
              <img src="${authorPic}" alt="${author.name}" class="avatar">
              <div>
                <div class="username">${author.name}</div>
                <div style="font-size:.8rem; color:var(--text-secondary-color);">@${post.username}</div>
              </div>
              <div class="timestamp">${timeAgo(post.created_at)} ago</div>
            </div>
            <div class="post-content">
              <p>${post.content || ''}</p>
              ${Array.isArray(post.media) && post.media.length>0
                ? `<div class="post-media-grid">${post.media.map(m => `<img src="${m}" alt="Post media" class="post-media">`).join('')}</div>`
                : ''
              }
            </div>
            <div class="post-actions">
              <button class="action-btn like-btn ${post.liked_by?.includes(currentUser.username) ? 'liked' : ''}" data-type="post" data-id="${post.id}">
                <i class="fas fa-heart"></i> <span class="like-count">${post.liked_by ? post.liked_by.length : 0}</span>
              </button>
              <button class="action-btn comment-btn" data-type="post" data-id="${post.id}">
                <i class="fas fa-comment"></i> <span>${post.comments ? post.comments.length : 0}</span>
              </button>
            </div>
            <div class="comments-section" data-post-id="${post.id}">
              <div class="comments-list">
                ${(post.comments||[]).slice(-3).map(c => `<div class="comment-item"><b>${userDetails(c.username).name||c.username}:</b> ${c.text}</div>`).join('')}
              </div>
              <form class="comment-form" data-post-id="${post.id}" autocomplete="off" style="display:flex;gap:6px;margin-top:8px;">
                <input type="text" class="comment-input" name="comment" placeholder="Write a comment..." style="flex:1;padding:6px 10px;border-radius:8px;border:1px solid #ccc;" maxlength="200"/>
                <button type="submit" class="btn-secondary">Post</button>
              </form>
            </div>
          `;
          container.appendChild(el);
        });
        // Add Load More button if there are more posts
        if (allPosts.length > end) {
          const btn = document.createElement('button');
          btn.textContent = 'Load More';
          btn.className = 'btn-primary';
          btn.style.display = 'block';
          btn.style.margin = '20px auto';
          btn.onclick = function(){
            page++;
            renderPage();
          };
          container.appendChild(btn);
        }
      }
      renderPage();
      // Remove any previous comment event listener
      if (container._commentHandler) container.removeEventListener('submit', container._commentHandler);
      // Attach comment form event delegation to this container
      container._commentHandler = async function(e) {
        const form = e.target.closest('.comment-form');
        if (!form) return;
        e.preventDefault();
        const input = form.querySelector('.comment-input');
        const text = input.value.trim();
        if (!text) return;
        const postId = form.getAttribute('data-post-id');
        form.querySelector('button[type="submit"]').disabled = true;
        const res = await apiFetch('/api/comment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type: 'post', id: postId, comment: text })
        });
        form.querySelector('button[type="submit"]').disabled = false;
        if (res && res.id) {
          input.value = '';
          // Reload posts to update comments
          const posts = await apiFetch('/api/posts');
          if (posts) {
            allPosts = posts;
            renderPage();
          }
        }
      };
      container.addEventListener('submit', container._commentHandler);
    }
    // Global error handler for easier debugging
    window.addEventListener('error', function(e) {
      console.error('Global JS Error:', e.message, e.error);
      showToast('A JavaScript error occurred. Check console.', 'error');
    });

    function renderAds(container, ads){
      container.innerHTML = '';
      if (!ads || ads.length === 0){
        container.innerHTML = '<p style="text-align:center; color: #65676b;">No ads found.</p>';
        return;
      }
      ads.forEach(ad => {
        const el = document.createElement('div');
        el.className = 'ad-card card';
        el.innerHTML = `
          ${Array.isArray(ad.media) && ad.media.length>0 ? `<img src="${ad.media[0]}" alt="Ad media" class="post-media">` : ''}
          <div class="ad-content">
            <p>${ad.content || ''}</p>
            <small style="color:var(--text-secondary-color);">Posted by @${ad.username}</small>
          </div>`;
        container.appendChild(el);
      });
    }

    function renderStories(container, stories){
      container.innerHTML = '';
      if (!stories || stories.length === 0){
        container.innerHTML = '<p style="text-align:center; color: #65676b;">No stories today.</p>';
        return;
      }
      stories.forEach((story, idx) => {
        const author = userDetails(story.username);
        const pic = author.profile_pic ? author.profile_pic : avatarDataURL(author.name);
        const el = document.createElement('div');
        el.className = 'story-item';
        el.setAttribute('data-story-idx', idx);
        el.innerHTML = `<img src="${pic}" alt="${author.name}" class="avatar"><p>${author.name}</p>`;
        container.appendChild(el);
      });
      // Save stories for modal viewing
      window._allStories = stories;
    }

    function renderNotifications(container, notifs){
      container.innerHTML = '';
      if (!notifs || notifs.length === 0){
        container.innerHTML = '<p style="text-align:center; color: #65676b;">No new notifications.</p>';
        return;
      }
      notifs.forEach(n => {
        const li = document.createElement('li');
        li.className = `notification-item ${n.read ? '' : 'unread'}`;
        li.dataset.id = n.id;
        li.innerHTML = `
          <i class="fas fa-info-circle"></i>
          <div>
            <p>${n.text}</p>
            <small style="color:var(--text-secondary-color);">${timeAgo(n.created_at)} ago</small>
          </div>`;
        container.appendChild(li);
      });
    }

    function renderChatPartners(container, partners){
      container.innerHTML = '';
      if (!partners || partners.length === 0){
        container.innerHTML = '<p style="padding:20px; text-align:center; color: #65676b;">No conversations yet.</p>';
        return;
      }
      partners.forEach(p => {
        const info = userDetails(p.username);
        const pic = info.profile_pic ? info.profile_pic : avatarDataURL(info.name);
        const item = document.createElement('div');
        item.className = 'chat-partner-item';
        item.dataset.username = p.username;
        item.innerHTML = `
          <img src="${pic}" alt="${info.name}" class="avatar">
          <div>
            <div class="name">${info.name}</div>
            <div style="font-size:.8rem; color:var(--text-secondary-color);">@${p.username}</div>
          </div>`;
        container.appendChild(item);
      });
    }

    function renderMessages(container, messages){
      container.innerHTML = '';
      (messages || []).forEach(msg => {
        const bubble = document.createElement('div');
        bubble.className = `message-bubble ${msg.sender === currentUser.username ? 'sent' : 'received'}`;
        let mediaHtml = '';
        if (msg.media) {
          if (msg.media.match(/\.(mp4|webm|ogg)$/i)) {
            mediaHtml = `<video src="${msg.media}" controls style="max-width:100%;max-height:180px;border-radius:10px;margin-top:6px;"></video>`;
          } else {
            mediaHtml = `<img src="${msg.media}" alt="Media" style="max-width:100%;max-height:180px;border-radius:10px;margin-top:6px;"/>`;
          }
        }
        bubble.innerHTML = `${msg.text ? msg.text : ''}${mediaHtml}`;
        container.appendChild(bubble);
      });
      container.scrollTop = container.scrollHeight;
    }

    /* ================= NAV + LOADERS ================= */
    function switchSection(sectionId, callback) {
      // Hide all content sections
      contentSections.forEach(s => s.classList.remove('active'));
      // Show the selected section
      document.getElementById(sectionId)?.classList.add('active');
      // Update nav link active state
      document.querySelectorAll('.nav-link, .mobile-nav-link').forEach(link => {
        link.classList.toggle('active', link.dataset.section === sectionId);
      });
      loadContentForSection(sectionId, callback);
    }

    async function loadContentForSection(sectionId, callback) {
      if (loadedSections.has(sectionId) && sectionId !== 'notifications') {
        if (typeof callback === 'function') callback();
        return;
      }

      const container = document.getElementById(sectionId);
      if (!container) {
        if (typeof callback === 'function') callback();
        return;
      }

      const contentArea = container.querySelector('.feed-container, .ads-container, .stories-list, .notification-list, .chat-partners');
      if (contentArea) contentArea.innerHTML = '<div class="loader-container"><div class="loader"></div></div>';

      switch(sectionId){
        case 'home': {
          const posts = await apiFetch('/api/posts');
          if (posts) renderPosts(document.getElementById('posts-feed'), posts);
          break;
        }
        case 'explore': {
          const ads = await apiFetch('/api/ads');
          if (ads) renderAds(document.getElementById('ads-grid'), ads);
          break;
        }
        case 'updates': {
          const stories = await apiFetch('/api/stories');
          if (stories) renderStories(document.getElementById('stories-container'), stories);
          break;
        }
        case 'notifications': {
          const notifs = await apiFetch('/api/notifications');
          if (notifs) renderNotifications(document.getElementById('notifications-list'), notifs);
          break;
        }
        case 'chat': {
          const partners = await apiFetch('/api/messages');
          if (partners) renderChatPartners(document.getElementById('chat-partners-list'), partners);
          break;
        }
      }
      loadedSections.add(sectionId);
      if (typeof callback === 'function') callback();
    }

    // ...existing code...

    // Comment form handler for all posts
    document.body.addEventListener('submit', async function(e) {
      if (e.target.classList.contains('comment-form')) {
        e.preventDefault();
        const form = e.target;
        const postId = form.getAttribute('data-post-id');
        const input = form.querySelector('input[name="comment"]');
        const commentText = input.value.trim();
        if (!commentText) return;
        input.disabled = true;
        form.querySelector('button[type="submit"]').disabled = true;
        try {
          const res = await fetch('/api/comment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: 'post', id: postId, comment: commentText })
          });
          if (res.ok) {
            input.value = '';
            // Optionally, reload comments for this post
            // You can call your renderPosts() or similar function here
            location.reload(); // Simple: reload page to show new comment
          } else {
            const err = await res.json();
            alert(err.error || 'Failed to post comment');
          }
        } finally {
          input.disabled = false;
          form.querySelector('button[type="submit"]').disabled = false;
        }
      }
    });

    /* ================= MODALS ================= */
    function setupModals(){
      document.getElementById('create-ad-btn')?.addEventListener('click', ()=> modals.ad.style.display = 'flex');
      document.getElementById('create-story-btn')?.addEventListener('click', ()=> modals.story.style.display = 'flex');
      document.getElementById('edit-profile-btn')?.addEventListener('click', ()=> modals.editProfile.style.display = 'flex');
      document.getElementById('new-chat-btn')?.addEventListener('click', openNewChatModal);

      Object.values(modals).forEach(modal => {
        modal.addEventListener('click', (e)=>{
          if (e.target === modal || e.target.classList.contains('modal-close-btn')) {
            modal.style.display = 'none';
          }
        });
      });
    }

    function openNewChatModal(){
      const wrap = document.getElementById('new-chat-list');
      wrap.innerHTML = '';
      (allUsers || []).filter(u => u.username !== currentUser.username).forEach(u => {
        const row = document.createElement('div');
        row.className = 'chat-partner-item';
        const pic = u.profile_pic ? u.profile_pic : avatarDataURL(u.name);
        row.innerHTML = `
          <img class="avatar" src="${pic}" alt="${u.name}"/>
          <div style="flex:1">
            <div class="name">${u.name}</div>
            <div style="font-size:.8rem; color:var(--text-secondary-color);">@${u.username}</div>
          </div>
          <button class="btn-primary" data-start-chat="${u.username}">Message</button>`;
        wrap.appendChild(row);
      });
      modals.newChat.style.display = 'flex';
    }

    // Story viewer modal logic
    function showStoryModal(idx) {
      const stories = window._allStories || [];
      if (!stories[idx]) return;
      const story = stories[idx];
      const author = userDetails(story.username);
      const modal = document.getElementById('story-viewer-modal');
      const content = modal.querySelector('.story-viewer-content');
      let mediaHtml = '';
      if (Array.isArray(story.media) && story.media.length > 0) {
        // Show first media only for now
        const m = story.media[0];
        if (m.match(/\.(mp4|webm|ogg)$/i)) {
          mediaHtml = `<video src="${m}" controls style="max-width:100%;max-height:320px;border-radius:10px;"></video>`;
        } else {
          mediaHtml = `<img src="${m}" alt="Story media" style="max-width:100%;max-height:320px;border-radius:10px;"/>`;
        }
      }
      content.innerHTML = `
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
          <img src="${author.profile_pic ? author.profile_pic : avatarDataURL(author.name)}" class="avatar" style="width:48px;height:48px;"/>
          <div>
            <div style="font-weight:800;">${author.name}</div>
            <div style="font-size:.85rem;color:var(--text-secondary-color);">@${story.username}</div>
          </div>
          <div style="margin-left:auto;font-size:.9rem;color:var(--text-secondary-color);">${timeAgo(story.created_at)} ago</div>
        </div>
        <div style="margin-bottom:12px;">${story.content ? story.content : ''}</div>
        ${mediaHtml}
      `;
      modal.style.display = 'flex';
      // Navigation (optional: next/prev)
      modal.setAttribute('data-story-idx', idx);
    }

    // Add story click event (event delegation)
    document.addEventListener('click', function(e) {
      const storyItem = e.target.closest('.story-item');
      if (storyItem && storyItem.hasAttribute('data-story-idx')) {
        showStoryModal(Number(storyItem.getAttribute('data-story-idx')));
      }
      // Story modal close
      const storyModal = document.getElementById('story-viewer-modal');
      if (storyModal && (e.target === storyModal || e.target.classList.contains('modal-close-btn'))) {
        storyModal.style.display = 'none';
      }
      // Story modal next/prev
      if (e.target.classList.contains('story-next-btn')) {
        const idx = Number(storyModal.getAttribute('data-story-idx'));
        const stories = window._allStories || [];
        if (idx < stories.length - 1) showStoryModal(idx + 1);
      }
      if (e.target.classList.contains('story-prev-btn')) {
        const idx = Number(storyModal.getAttribute('data-story-idx'));
        if (idx > 0) showStoryModal(idx - 1);
      }
    });

    /* ================= FORMS ================= */
    async function handleFormSubmit(e, url, refreshSection){
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      const btn = form.querySelector('button[type="submit"]');
      const old = btn.textContent;
      btn.disabled = true; btn.textContent = 'Submitting...';

      const result = await apiFetch(url, { method: 'POST', body: formData });

      btn.disabled = false; btn.textContent = old;

      if (result) {
        showToast(`${refreshSection} created successfully!`);
        form.reset();
        const modal = form.closest('.modal-overlay');
        if (modal) modal.style.display = 'none';
        loadContentForSection(refreshSection);
        // If story created and currently on updates, reload stories instantly
        if (refreshSection === 'updates' && document.getElementById('updates').classList.contains('active')) {
          loadContentForSection('updates');
        }
        // If post created and currently on home/profile, reload posts instantly
        if (refreshSection === 'profile' && document.getElementById('profile').classList.contains('active')) {
          loadContentForSection('profile');
        }
        if (refreshSection === 'home' && document.getElementById('home').classList.contains('active')) {
          loadContentForSection('home');
        }
        // If notification created and currently on notifications, reload instantly
        if (refreshSection === 'notifications' && document.getElementById('notifications').classList.contains('active')) {
          loadContentForSection('notifications');
        }
      }
    }

    document.getElementById('create-post-form-main').addEventListener('submit',(e)=>handleFormSubmit(e,'/api/posts','profile'));
    document.getElementById('create-ad-form').addEventListener('submit',(e)=>handleFormSubmit(e,'/api/ads','explore'));
    document.getElementById('create-story-form').addEventListener('submit',(e)=>handleFormSubmit(e,'/api/stories','updates'));

    document.getElementById('edit-profile-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const result = await apiFetch('/api/profile/edit', { method: 'POST', body: new FormData(form) });
      if (result && result.success){
        showToast('Profile updated!');
        modals.editProfile.style.display = 'none';
        document.getElementById('profile-name').textContent = result.user.name;
        document.getElementById('profile-username').textContent = `@${result.user.username}`;
        document.getElementById('profile-bio').textContent = result.user.bio || 'No bio yet.';
        document.getElementById('profile-phone').innerHTML = `<strong>Phone:</strong> ${result.user.phone || ''}`;
        document.getElementById('profile-pic-large').src = result.user.profile_pic || avatarDataURL(result.user.name);
        // keep users cache fresh
        const idx = allUsers.findIndex(u => u.username === result.user.username);
        if (idx >= 0) allUsers[idx] = result.user;
      }
    });

    // Attach media button logic
    document.addEventListener('click', function(e) {
      if (e.target.closest && e.target.closest('#attach-media-btn')) {
        document.getElementById('message-media-input').click();
      }
    });
    // Chat window interactions
    document.addEventListener('click', async (e) => {
      // Like
      const likeBtn = e.target.closest('.like-btn');
      if (likeBtn) {
        const { type, id } = likeBtn.dataset;
        const result = await apiFetch('/api/like', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type, id })
        });
        if (result) {
          likeBtn.classList.toggle('liked', result.action === 'liked');
          likeBtn.querySelector('.like-count').textContent = result.liked_by.length;
        }
        return;
      }

      // Notification read
      const notif = e.target.closest('.notification-item.unread');
      if (notif) {
        const { id } = notif.dataset;
        const res = await apiFetch(`/api/notifications/read/${id}`, { method: 'POST' });
        if (res && res.success) notif.classList.remove('unread');
        return;
      }

      // Open chat partner
      const chatPartner = e.target.closest('.chat-partner-item');
      if (chatPartner && chatPartner.dataset.username) {
        const username = chatPartner.dataset.username;
        document.querySelectorAll('.chat-partner-item').forEach(i => i.classList.remove('active'));
        chatPartner.classList.add('active');

        document.querySelector('.chat-window-placeholder')?.classList.add('hidden');
        const header = document.getElementById('chat-header');
        header.textContent = userDetails(username).name;
        header.classList.remove('hidden');

        document.getElementById('message-form').classList.remove('hidden');
        document.getElementById('message-receiver-input').value = username;

        const msgArea = document.getElementById('chat-messages-area');
        msgArea.innerHTML = '<div class="loader-container"><div class="loader"></div></div>';
        const messages = await apiFetch(`/api/messages?with=${encodeURIComponent(username)}`);
        if (messages) renderMessages(msgArea, messages);
        return;
      }

      // Start chat from modal
      const startBtn = e.target.closest('[data-start-chat]');
      if (startBtn) {
        const username = startBtn.getAttribute('data-start-chat');
        const res = await apiFetch('/api/messages/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ with: username })
        });
        if (res) {
          showToast('Chat opened!');
          modals.newChat.style.display = 'none';
          // Ensure chat list refreshes and open it
          loadedSections.delete('chat');
          switchSection('chat', async () => {
            // Try to find and click the chat partner row, or add it if missing
            function tryClickPartner(attempts = 0) {
              let row = [...document.querySelectorAll('.chat-partner-item')].find(r => r.dataset.username === username);
              if (row) {
                row.click();
              } else if (attempts < 10) {
                setTimeout(() => tryClickPartner(attempts + 1), 80);
              } else {
                // If not found after retries, add the partner manually and click
                const chatPartnersList = document.getElementById('chat-partners-list');
                const info = userDetails(username);
                const pic = info.profile_pic ? info.profile_pic : avatarDataURL(info.name);
                const item = document.createElement('div');
                item.className = 'chat-partner-item';
                item.dataset.username = username;
                item.innerHTML = `
                  <img src="${pic}" alt="${info.name}" class="avatar">
                  <div>
                    <div class="name">${info.name}</div>
                    <div style="font-size:.8rem; color:var(--text-secondary-color);">@${username}</div>
                  </div>`;
                chatPartnersList.appendChild(item);
                item.click();
              }
            }
            tryClickPartner();
          });
        }
        return;
      }

      // Start chat from search user card
      const searchMsgBtn = e.target.closest('[data-msg-user]');
      if (searchMsgBtn) {
        const username = searchMsgBtn.getAttribute('data-msg-user');
        const res = await apiFetch('/api/messages/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ with: username })
        });
        if (res) {
          showToast('Chat opened!');
          switchSection('chat', async () => {
            function tryClickPartner(attempts = 0) {
              let row = [...document.querySelectorAll('.chat-partner-item')].find(r => r.dataset.username === username);
              if (row) {
                row.click();
              } else if (attempts < 10) {
                setTimeout(() => tryClickPartner(attempts + 1), 80);
              } else {
                const chatPartnersList = document.getElementById('chat-partners-list');
                const info = userDetails(username);
                const pic = info.profile_pic ? info.profile_pic : avatarDataURL(info.name);
                const item = document.createElement('div');
                item.className = 'chat-partner-item';
                item.dataset.username = username;
                item.innerHTML = `
                  <img src="${pic}" alt="${info.name}" class="avatar">
                  <div>
                    <div class="name">${info.name}</div>
                    <div style="font-size:.8rem; color:var(--text-secondary-color);">@${username}</div>
                  </div>`;
                chatPartnersList.appendChild(item);
                item.click();
              }
            }
            tryClickPartner();
          });
        }
      }
    });

    // Send message (with media support)
    document.getElementById('message-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const textInput = document.getElementById('message-input');
      const mediaInput = document.getElementById('message-media-input');
      const messageText = textInput.value.trim();
      const hasMedia = mediaInput.files && mediaInput.files.length > 0;
      if (!messageText && !hasMedia) return;

      const formData = new FormData(form);
      // Only append file if selected
      if (hasMedia) {
        formData.set('media', mediaInput.files[0]);
      } else {
        formData.delete('media');
      }

      const result = await apiFetch('/api/messages', { method: 'POST', body: formData });
      if (result) {
        textInput.value = '';
        mediaInput.value = '';
        // Reload messages from server to ensure sent message appears
        const receiver = document.getElementById('message-receiver-input').value;
        const msgArea = document.getElementById('chat-messages-area');
        msgArea.innerHTML = '<div class="loader-container"><div class="loader"></div></div>';
        const messages = await apiFetch(`/api/messages?with=${encodeURIComponent(receiver)}`);
        if (messages) renderMessages(msgArea, messages);
      }
    });

    // Search
    document.getElementById('search-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const query = document.getElementById('search-input').value.trim();
      if (!query) return;
      const container = document.getElementById('search-results-container');
      container.innerHTML = '<div class="loader-container"><div class="loader"></div></div>';
      const results = await apiFetch(`/api/search?q=${encodeURIComponent(query)}`);
      if (!results) return;
      container.innerHTML = '';

      const groups = ['users','posts','ads','stories'];
      groups.forEach(type => {
        const list = results[type];
        if (Array.isArray(list) && list.length>0) {
          const title = document.createElement('h3');
          title.textContent = type[0].toUpperCase() + type.slice(1);
          container.appendChild(title);

          const wrap = document.createElement('div');
          if (type === 'users') {
            list.forEach(item => {
              const info = userDetails(item.username);
              const pic = info.profile_pic ? info.profile_pic : avatarDataURL(info.name);
              const card = document.createElement('div');
              card.className = 'card';
              card.innerHTML = `
                <div style="display:flex; align-items:center; gap:10px;">
                  <img class="avatar" src="${pic}" alt="${info.name}"/>
                  <div style="flex:1">
                    <div style="font-weight:800">${info.name}</div>
                    <div style="font-size:.85rem; color:var(--text-secondary-color)">@${item.username}</div>
                  </div>
                  <button class="btn-primary" data-msg-user="${item.username}"><i class="fas fa-paper-plane"></i> Message</button>
                </div>`;
              wrap.appendChild(card);
            });
          } else {
            list.forEach(item => {
              const card = document.createElement('div');
              card.className = 'card';
              card.textContent = item.content || '';
              wrap.appendChild(card);
            });
          }
          container.appendChild(wrap);
        }
      });

      if (!container.innerHTML.trim()) container.innerHTML = '<p>No results found.</p>';
    });

    /* ================= SETTINGS (Appearance + Support) ================= */
    const settingsState = {
      dark: false,
      mood: 'blue',
      fontSize: 16,
      fontFamily: getComputedStyle(document.documentElement).getPropertyValue('--font-family-base').trim()
    };

    const toggleDark = document.getElementById('toggle-dark');
    const fontSizeRange = document.getElementById('font-size-range');
    const fontSizeLabel = document.getElementById('font-size-label');
    const fontFamilySelect = document.getElementById('font-family-select');

    function loadSettings(){
      try {
        const saved = JSON.parse(localStorage.getItem('rwchat.settings') || '{}');
        Object.assign(settingsState, saved);
      } catch{}
      applySettings();
      // UI sync
      toggleDark.checked = !!settingsState.dark;
      document.querySelectorAll('input[name="mood"]').forEach(r => r.checked = (r.value === settingsState.mood));
      fontSizeRange.value = settingsState.fontSize || 16;
      fontSizeLabel.textContent = fontSizeRange.value + 'px';
      if (settingsState.fontFamily) fontFamilySelect.value = settingsState.fontFamily;
    }

    function saveSettings(){
      localStorage.setItem('rwchat.settings', JSON.stringify(settingsState));
      // Optional: persist to backend (ignore errors)
      apiFetch('/api/settings', {
        method:'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(settingsState)
      });
    }

    function applySettings(){
      document.documentElement.classList.toggle('theme-dark', !!settingsState.dark);
      document.documentElement.classList.remove('mood-blue','mood-green','mood-orange');
      document.documentElement.classList.add('mood-' + (settingsState.mood || 'blue'));
      document.documentElement.style.setProperty('--font-size-base', (settingsState.fontSize || 16) + 'px');
      if ( settingsState.fontFamily) {

        document.documentElement.style.setProperty('--font-family-base', settingsState.fontFamily);
      }
    }

    toggleDark.addEventListener('change', () => {
      settingsState.dark = toggleDark.checked; applySettings(); saveSettings();
    });
    document.querySelectorAll('input[name="mood"]').forEach(r => {
      r.addEventListener('change', () => {
        settingsState.mood = r.value; applySettings(); saveSettings();
      });
    });
    fontSizeRange.addEventListener('input', () => {
      settingsState.fontSize = Number(fontSizeRange.value);
      fontSizeLabel.textContent = fontSizeRange.value + 'px';
      applySettings(); saveSettings();
    });
    fontFamilySelect.addEventListener('change', () => {
      settingsState.fontFamily = fontFamilySelect.value; applySettings(); saveSettings();
    });

    // Support forms
    document.getElementById('system-support-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const res = await apiFetch('/api/support/system', { method:'POST', body: new FormData(e.target) });
      if (res) { showToast('Sent to system support!'); e.target.reset(); }
    });
    document.getElementById('gov-support-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const res = await apiFetch('/api/support/government', { method:'POST', body: new FormData(e.target) });
      if (res) { showToast('Sent to government support!'); e.target.reset(); }
    });

    /* ================= INIT ================= */
    setupModals();
    loadSettings();

    // Set profile image safely (no http placeholder)
    const profileImg = document.getElementById('profile-pic-large');
    profileImg.src = (currentUser.profile_pic && currentUser.profile_pic.trim()) ? currentUser.profile_pic : avatarDataURL(currentUser.name);

    // On first load, Home is active by default

    // Remove any previous nav click handlers to avoid duplicates
    if (window._rwchatNavHandler) {
      document.body.removeEventListener('click', window._rwchatNavHandler);
    }

    // Dedicated navigation click handler
    function rwchatNavHandler(e) {
      // Only handle left-click or keyboard activation
      if (e.type === 'click' && e.button !== 0) return;
      // Find the closest nav link (not inside a select)
      const navLink = e.target.closest('a.nav-link, a.mobile-nav-link, button.nav-link-mobile-header');
      if (!navLink) return;
      // Ignore if the click is on a select or inside a select
      if (e.target.tagName === 'SELECT' || navLink.contains(document.activeElement) && document.activeElement.tagName === 'SELECT') return;
      // Ignore if navLink or its parent is a select
      if (navLink.closest('select')) return;
      // Ignore if navLink is disabled
      if (navLink.disabled) return;
      // Ignore if navLink has no data-section
      const section = navLink.dataset.section;
      if (!section) return;
      e.preventDefault();
      // Debug logs
      console.log('[RWCHAT NAV] Clicked nav link:', navLink, 'Section:', section);
      // Hide all content sections
      document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
      // Show the selected section
      const sectionEl = document.getElementById(section);
      if (sectionEl) {
        sectionEl.classList.add('active');
      } else {
        console.warn('[RWCHAT NAV] No section element found for:', section);
      }
      // Update nav link active state (desktop, mobile, header)
      document.querySelectorAll('.nav-link, .mobile-nav-link, .nav-link-mobile-header').forEach(l => {
        l.classList.toggle('active', l.dataset.section === section);
      });
      // Always load content for section (force reload)
      if (typeof loadContentForSection === 'function') {
        loadedSections.delete(section);
        loadContentForSection(section, function() {
          // Remove loader if API fails
          const container = document.getElementById(section);
          if (container) {
            const contentArea = container.querySelector('.feed-container, .ads-container, .stories-list, .notification-list, .chat-partners');
            if (contentArea && contentArea.innerHTML.includes('loader')) {
              setTimeout(() => {
                if (contentArea.innerHTML.includes('loader')) contentArea.innerHTML = '<p style="text-align:center; color: #65676b;">No data found.</p>';
              }, 1200);
            }
          }
        });
      }
    }
    document.body.addEventListener('click', rwchatNavHandler);
    window._rwchatNavHandler = rwchatNavHandler;
  });
  </script>
</body>
</html>
